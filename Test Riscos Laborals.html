<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test de Prevención de Riesgos Laborales</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Estils per a la barra de progrés */
    #progress-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 1rem;
      position: relative; /* Necesario para posicionar el texto de porcentaje si lo quisieras dentro y separado, pero lo moveremos fuera */
    }

    #progress-bar {
      height: 20px;
      background-color: #4CAF50;
      width: 0%;
      border-radius: 5px;
      /* ELIMINADO: text-align, color, line-height para que el texto NO aparezca dentro de la barra */
      transition: width 0.5s ease-in-out;
    }

    /* Estils per al modal */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
      text-align: center;
    }

    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .fade { transition: all 0.3s ease-in-out; }

    .disabled-option {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen p-4 flex items-center justify-center">
  <div id="app" class="max-w-xl w-full bg-white shadow-xl rounded-2xl p-6">
    <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">Test de Prevención de Riesgos Laborales</h1>

    <div id="barra-nivells" class="flex flex-wrap justify-center gap-3 mb-6">
      <button onclick="iniciaNivell(1)" class="level-button bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">Nivell 1</button>
      <button onclick="iniciaNivell(2)" class="level-button bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition-colors duration-200">Nivell 2</button>
      <button onclick="iniciaNivell(3)" class="level-button bg-purple-600 text-white px-5 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">Nivell 3</button>
    </div>

    <div id="quiz-container" class="hidden">
      <div id="progress-container" class="mb-2">
        <div id="progress-bar"></div>
      </div>
      <div id="question-area"></div>
      <div id="feedback" class="mt-4 text-center text-lg font-semibold"></div>
      <div class="flex justify-between items-center mt-6">
        <div id="score" class="text-base text-gray-600">Encerts totals: 0 / 0</div> <button id="next-btn" class="hidden bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">Següent</button>
      </div>
    </div>

    <div id="nivellCompletatModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="amagaModal()">&times;</span>
        <h2 id="nivellCompletatText" class="text-2xl font-bold mb-4"></h2>
        <p class="text-gray-700 mb-6">Has respost totes les preguntes d'aquest nivell.</p>
        <button onclick="repetirNivell()" class="bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 transition-colors duration-200 mr-4">Repetir Nivell</button>
        <button id="botoPujarNivell" onclick="pujarNivell()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 hidden">Pujar al següent Nivell</button>
      </div>
    </div>

    <div id="repasModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="amagaRepasModal()">&times;</span>
        <h2 class="text-2xl font-bold mb-4">Repàs de Preguntes Fallades</h2>
        <p class="text-gray-700 mb-6">Aquí tens les preguntes que no has encertat per revisar-les.</p>
        <div id="preguntesFalladesContainer" class="text-left max-h-80 overflow-y-auto mb-6 p-2 border rounded-lg bg-gray-50"></div>
        <button onclick="amagaRepasModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">Entenc</button>
      </div>
    </div>

    <div id="finalTestModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="amagaFinalTestModal()">&times;</span>
        <h2 class="text-2xl font-bold mb-4">¡Test Finalitzat!</h2>
        <p class="text-gray-700 mb-6">Has completat tots els nivells. ¡Felicitats!</p>
        <button onclick="iniciaNivell(1); amagaFinalTestModal();" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 mr-4">Tornar a començar</button>
        <button onclick="mostraRepasFallades()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">Revisar fallades</button>
      </div>
    </div>

  </div>

  <script>
    let totsElsNivellsPreguntes = {
      1: [
        // Preguntas del PDF - Ejercicio 1 (Test)
        {
          pregunta: "Según la Organización Mundial de la Salud (OMS), la salud se puede definir como:",
          tipus: "test",
          opcions: [
            "No padecer enfermedades físicas",
            "No sufrir enfermedades psíquicas.",
            "No padecer estrés.",
            "El estado completo del bienestar físico, psíquico y social."
          ],
          correcta: 3
        },
        {
          pregunta: "Los daños derivados del trabajo son:",
          tipus: "test",
          opcions: [
            "Las enfermedades patológicas o lesiones sufridas con motivo u ocasión del trabajo.",
            "Las incapacidades temporales con baja superior a cinco días",
            "La insatisfacción laboral por los ritmos de trabajo.",
            "Las lesiones producidas por no utilizar los medios de protección personal."
          ],
          correcta: 0
        },
        {
          pregunta: "La Ley de Prevención de Riesgos Laborales entiende por accidente:",
          tipus: "test",
          opcions: [
            "El suceso que produce lesiones al trabajador.",
            "El acontecimiento que causa daños a la maquinaria de la empresa.",
            "Cualquier acontecimiento imprevisto que interrumpa o interfiera el proceso ordenado de la actividad laboral, aún cuando no haya habido personas lesionadas.",
            "El suceso que produce daños materiales y lesiones corporales."
          ],
          correcta: 2
        },
        {
          pregunta: "El empresario organizará el desarrollo de la actividad preventiva en las empresas que carezcan de riesgos importantes y que tengan menos de 6 trabajadores:",
          tipus: "test",
          opcions: [
            "Asumiendo personalmente la actividad.",
            "Constituyendo un servicio de prevención propio.",
            "Constituyendo un servicio de prevención ajeno",
            "Designando a uno o varios trabajadores para que la lleven a cabo."
          ],
          correcta: 0
        },
        {
          pregunta: "En una empresa de 40 trabajadores es obligatorio que exista:",
          tipus: "test",
          opcions: [
            "Un Servicio de Prevención Propio.",
            "Uno o varios trabajadores designados.",
            "Un Servicio de Prevención Ajeno.",
            "Un comité de seguridad y salud."
          ],
          correcta: 1
        },
        // Preguntas nuevas del PowerPoint - Nivel 1
        {
          pregunta: "¿Qué tres elementos principales se relacionan en el contexto de la prevención de riesgos laborales?",
          tipus: "test",
          opcions: [
            "Producción, Beneficios y Empleados",
            "Empresa, Trabajadores y Seguridad y Salud",
            "Costos, Calidad y Riesgos",
            "Mercado, Clientes y Proveedores"
          ],
          correcta: 1
        },
        {
          pregunta: "El trabajo, si se realiza en condiciones adecuadas a nuestras capacidades personales y en condiciones ambientales y de seguridad, puede suponer una fuente de ____________ personal y por tanto de salud.",
          tipus: "completar",
          correcta: "autorrealización",
          opcionsDesplegable: ["bienestar", "autorrealización", "ingresos", "productividad"]
        },
        {
          pregunta: "¿Cuál es la principal razón por la que trabajamos, según el temario?",
          tipus: "test",
          opcions: [
            "Por desarrollo personal",
            "Por dinero",
            "Para satisfacer nuestras necesidades",
            "Para una vida más cómoda"
          ],
          correcta: 2
        },
        {
          pregunta: "El objetivo fundamental de la prevención de riesgos laborales es:",
          tipus: "test",
          opcions: [
            "Reducir los costes empresariales.",
            "Aumentar la productividad de los trabajadores.",
            "Conseguir que las condiciones de trabajo no perjudiquen la salud de los trabajadores/as.",
            "Cumplir con las normativas legales mínimas."
          ],
          correcta: 2
        },
        {
          pregunta: "Relaciona cada técnica preventiva con su objetivo principal:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Seguridad en el Trabajo", correcta: "Estudia las condiciones materiales del trabajo para evitar accidentes." },
            { esquerra: "Higiene Industrial", correcta: "Se ocupa de los agentes contaminantes en el ambiente de trabajo." },
            { esquerra: "Ergonomía", correcta: "Se centra en el diseño de puestos de trabajo y el bienestar psicosocial." },
            { esquerra: "Psicosociología Aplicada", correcta: "Analiza los factores psicosociales y la organización del trabajo." }
          ]
        },
        {
          pregunta: "¿Qué técnica preventiva se encarga de analizar las condiciones materiales del trabajo para evitar accidentes?",
          tipus: "test",
          opcions: [
            "Higiene Industrial",
            "Ergonomía",
            "Seguridad en el Trabajo",
            "Medicina del Trabajo"
          ],
          correcta: 2
        },
        {
          pregunta: "Las enfermedades, patologías o lesiones sufridas con motivo u ocasión del trabajo se definen como ____________ del trabajo.",
          tipus: "completar",
          correcta: "daños derivados",
          opcionsDesplegable: ["riesgos inherentes", "daños derivados", "accidentes", "enfermedades"]
        },
        {
          pregunta: "¿Qué tipo de riesgo está relacionado con caídas, golpes o proyecciones?",
          tipus: "test",
          opcions: [
            "Riesgos higiénicos",
            "Riesgos psicosociales",
            "Riesgos de seguridad",
            "Riesgos ergonómicos"
          ],
          correcta: 2
        },
        {
          pregunta: "Relaciona cada tipo de riesgo con un ejemplo:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Riesgos de seguridad", correcta: "Caída al mismo nivel" },
            { esquerra: "Riesgos higiénicos", correcta: "Ruido" },
            { esquerra: "Riesgos ergonómicos", correcta: "Posturas forzadas" },
            { esquerra: "Riesgos psicosociales", correcta: "Estrés" }
          ]
        },
        {
          pregunta: "Un __________ de trabajo es todo suceso que produce lesiones en el trabajador.",
          tipus: "completar",
          correcta: "accidente",
          opcionsDesplegable: ["incidente", "accidente", "peligro", "riesgo"]
        },
        {
          pregunta: "¿Cuál de los siguientes NO es un tipo de riesgo, según la clasificación general?",
          tipus: "test",
          opcions: [
            "Riesgos de seguridad",
            "Riesgos económicos",
            "Riesgos higiénicos",
            "Riesgos ergonómicos"
          ],
          correcta: 1
        },
        {
          pregunta: "Una enfermedad profesional es la contraída a consecuencia del trabajo ejecutado por cuenta ajena en las actividades especificadas en el cuadro de enfermedades profesionales, y que esté provocada por los ____________ o __________ en dicho cuadro.",
          tipus: "completar",
          correcta: "agentes o procedimientos",
          opcionsDesplegable: ["factores o métodos", "agentes o procedimientos", "peligros o procesos", "sustancias o condiciones"]
        },
        {
          pregunta: "Cuál es el principal derecho de los trabajadores en materia de prevención?",
          tipus: "test",
          opcions: [
            "Derecho a un salario más alto.",
            "Derecho a la protección eficaz en materia de seguridad y salud.",
            "Derecho a elegir su horario de trabajo.",
            "Derecho a vacaciones pagadas."
          ],
          correcta: 1
        },
        {
          pregunta: "El empresario tiene la obligación de garantizar la __________ en materia de seguridad y salud en el trabajo.",
          tipus: "completar",
          correcta: "seguridad y salud",
          opcionsDesplegable: ["rentabilidad", "productividad", "seguridad y salud", "innovación"]
        },
        {
          pregunta: "Relaciona cada obligación del empresario con su descripción:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Integración de la prevención", correcta: "La prevención debe formar parte del sistema de gestión de la empresa." },
            { esquerra: "Evaluación de riesgos", correcta: "Realizar una evaluación de los riesgos." },
            { esquerra: "Información y formación", correcta: "Formar e informar a los trabajadores." },
            { esquerra: "Asumir los costes", correcta: "Asegurar que los costes de prevención no recaen en el trabajador." }
          ]
        },
        {
          pregunta: "El empresario tiene la obligación de ___________ los riesgos laborales.",
          tipus: "completar",
          correcta: "evaluar",
          opcionsDesplegable: ["minimizar", "asumir", "eliminar", "evaluar"]
        },
        {
          pregunta: "¿Qué obligación tiene el trabajador respecto a su propia seguridad y la de terceros?",
          tipus: "test",
          opcions: [
            "Realizar las tareas que le correspondan, sin importar el riesgo.",
            "Cooperar con el empresario en el cumplimiento de las obligaciones preventivas.",
            "Ignorar las normas de seguridad si considera que son ineficientes.",
            "Asumir los costes de los equipos de protección personal."
          ],
          correcta: 1
        },
        {
          pregunta: "La prevención de riesgos laborales debe estar integrada en el sistema general de gestión de la empresa, lo que se conoce como __________.",
          tipus: "completar",
          correcta: "integración de la prevención",
          opcionsDesplegable: ["planificación estratégica", "gestión de calidad", "integración de la prevención", "auditoría preventiva"]
        },
        {
          pregunta: "Relaciona cada modalidad de organización preventiva con su ámbito de aplicación general:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Asunción personal por el empresario", correcta: "Empresas con menos de 6 trabajadores y sin riesgos especiales." },
            { esquerra: "Trabajador/es Designado/s", correcta: "Empresas entre 6 y 50 trabajadores con riesgo normal, o 250 con un solo centro y riesgo normal." },
            { esquerra: "Servicio de Prevención Ajeno", correcta: "Empresas que no pueden asumir la prevención con medios propios." }
          ]
        },
        {
          pregunta: "¿Cuál es el órgano paritario y colegiado de participación destinado a la consulta regular y periódica de las actuaciones de la empresa en materia de prevención de riesgos?",
          tipus: "test",
          opcions: [
            "El Comité de Empresa",
            "El Comité de Seguridad y Salud",
            "Los Delegados de Personal",
            "La Inspección de Trabajo"
          ],
          correcta: 1
        }
      ],
      2: [
        // Preguntas del PDF - Ejercicio 4 (Abiertas, ahora con desplegable)
        {
          pregunta: "Si el empresario delega las actividades preventivas en trabajadores designados o en un servicio de prevención, ¿queda eximido de su responsabilidad?",
          tipus: "completar",
          correcta: "No, la responsabilidad es siempre indelegable.",
          opcionsDesplegable: ["Sí, completamente", "Sí, parcialmente", "No, la responsabilidad es siempre indelegable.", "Depende del tamaño de la empresa"]
        },
        {
          pregunta: "¿Sobre quién recae el coste de las medidas relativas a la seguridad y salud en el trabajo?",
          tipus: "completar",
          correcta: "El coste recae sobre el empresario. Bajo ningún concepto puede recaer sobre el trabajador.",
          opcionsDesplegable: ["El coste recae sobre el trabajador.", "El coste es compartido entre empresario y trabajador.", "El coste recae sobre el empresario. Bajo ningún concepto puede recaer sobre el trabajador.", "El coste es cubierto por la Seguridad Social."]
        },
        {
          pregunta: "¿El tiempo dedicado a la formación en prevención de riesgos laborales es tiempo de trabajo?",
          tipus: "completar",
          correcta: "Sí, se considera tiempo de trabajo a todos los efectos.",
          opcionsDesplegable: ["No, es tiempo libre del trabajador.", "Solo si se realiza fuera del horario laboral.", "Sí, se considera tiempo de trabajo a todos los efectos.", "Solo si el trabajador lo solicita."]
        },
        {
          pregunta: "¿A través de quién se llevan a cabo las consultas que el empresario debe realizar a los trabajadores en materia de prevención?",
          tipus: "completar",
          correcta: "A través de los Delegados de Prevención o, en su defecto, a través de los Representantes de los Trabajadores.",
          opcionsDesplegable: ["A través de los sindicatos exclusivamente.", "A través de los Delegados de Prevención o, en su defecto, a través de los Representantes de los Trabajadores.", "Directamente con cada trabajador.", "A través de encuestas anónimas."]
        },
        {
          pregunta: "¿Tienen los trabajadores derecho a la confidencialidad de la información relacionada con su estado de salud?",
          tipus: "completar",
          correcta: "Sí, tienen derecho a la confidencialidad de toda la información relacionada con su estado de salud.",
          opcionsDesplegable: ["No, el empresario puede acceder a ella.", "Solo si la información es grave.", "Sí, tienen derecho a la confidencialidad de toda la información relacionada con su estado de salud.", "Solo si lo autoriza un médico."]
        },
        {
          pregunta: "¿Los trabajadores tienen necesariamente que ser acompañados por los delegados de prevención para poner denuncias ante la Inspección de trabajo?",
          tipus: "completar",
          correcta: "No, los trabajadores no tienen necesariamente que ser acompañados. Tienen derecho a acudir a la Inspección de Trabajo por sí solos.",
          opcionsDesplegable: ["Sí, es obligatorio ser acompañado.", "No, los trabajadores no tienen necesariamente que ser acompañados. Tienen derecho a acudir a la Inspección de Trabajo por sí solos.", "Solo si la denuncia es anónima.", "Solo si el delegado de prevención lo autoriza."]
        },
        // Preguntas del PDF - Ejercicio 5 (Relacionar)
        {
          pregunta: "Relaciona los siguientes conceptos con el tipo de riesgo al que corresponden:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Riesgos derivados de las condiciones de seguridad", correcta: "HERRAMIENTAS Y EQUIPOS DE TRABAJO." },
            { esquerra: "Riesgos derivados de la organización del trabajo", correcta: "EL HORARIO Y EL RITMO DE TRABAJO" },
            { esquerra: "Riesgos derivados de la carga de trabajo", correcta: "CARGA MENTAL" },
            { esquerra: "Riesgos derivados del medio ambiente de trabajo", correcta: "EXPOSICIÓN A AGENTES BIOLÓGICOS" }
          ]
        },
        // Nuevas preguntas del PowerPoint - Nivel 2
        {
          pregunta: "¿Qué significan las siglas EPI en el contexto de prevención de riesgos laborales?",
          tipus: "completar",
          correcta: "Equipo de Protección Individual",
          opcionsDesplegable: ["Elementos de Protección Integral", "Equipo de Prevención Industrial", "Equipo de Protección Individual", "Estándares de Protección Inmediata"]
        },
        {
          pregunta: "¿Cuál es el objetivo principal de la Medicina del Trabajo?",
          tipus: "test",
          opcions: [
            "Curar todas las enfermedades de los trabajadores.",
            "Promover la salud, curar enfermedades y rehabilitar en el ámbito laboral.",
            "Realizar reconocimientos médicos anuales obligatorios.",
            "Dictaminar las causas de los accidentes laborales."
          ],
          correcta: 1
        },
        {
          pregunta: "La Medicina del Trabajo se especializa en la interacción entre el ser humano y el medio __________.",
          tipus: "completar",
          correcta: "de trabajo",
          opcionsDesplegable: ["social", "natural", "de vida", "de trabajo"]
        },
        {
          pregunta: "¿Qué técnica preventiva se encarga de analizar las condiciones ambientales de trabajo y los agentes contaminantes?",
          tipus: "test",
          opcions: [
            "Seguridad en el Trabajo",
            "Higiene Industrial",
            "Ergonomía",
            "Psicosociología Aplicada"
          ],
          correcta: 1
        },
        {
          pregunta: "Un ejemplo de riesgo higiénico sería la exposición a:",
          tipus: "test",
          opcions: [
            "Caídas de objetos",
            "Estrés laboral",
            "Ruido excesivo",
            "Movimientos repetitivos"
          ],
          correcta: 2
        },
        {
          pregunta: "La __________ se ocupa del diseño de puestos de trabajo y la adaptación del trabajo a la persona.",
          tipus: "completar",
          correcta: "ergonomía",
          opcionsDesplegable: ["psicosociología", "higiene", "ergonomía", "seguridad"]
        },
        {
          pregunta: "Relaciona el tipo de daño derivado del trabajo con su característica principal:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Accidente de Trabajo", correcta: "Suceso repentino" },
            { esquerra: "Enfermedad Profesional", correcta: "Enfermedad de lenta aparición" },
            { esquerra: "Otras patologías o lesiones", correcta: "Daño que no es accidente ni enfermedad profesional" }
          ]
        },
        {
          pregunta: "Los ____________ son un conjunto de técnicas y procedimientos que tienen por objeto eliminar o reducir el riesgo de que se produzcan accidentes de trabajo.",
          tipus: "completar",
          correcta: "riesgos de seguridad",
          opcionsDesplegable: ["riesgos higiénicos", "riesgos de seguridad", "riesgos psicosociales", "riesgos ergonómicos"]
        },
        {
          pregunta: "¿Qué es un 'incidente' en prevención de riesgos laborales?",
          tipus: "test",
          opcions: [
            "Un accidente con lesiones graves.",
            "Un suceso en el que no se producen daños ni lesiones, pero que podría haberlos producido.",
            "Una enfermedad profesional reconocida.",
            "Una situación de estrés laboral."
          ],
          correcta: 1
        },
        {
          pregunta: "La Ley de Prevención de Riesgos Laborales establece el marco normativo básico en España para garantizar la seguridad y salud de los trabajadores. ¿En qué año fue aprobada?",
          tipus: "test",
          opcions: [
            "1985",
            "1995",
            "2005",
            "2015"
          ],
          correcta: 1
        },
        {
          pregunta: "Relaciona el concepto con su definición:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Peligro", correcta: "Situación o característica intrínseca que puede causar daño." },
            { esquerra: "Riesgo", correcta: "Probabilidad de que el daño se materialice." },
            { esquerra: "Prevención", correcta: "Conjunto de medidas para evitar o reducir riesgos." }
          ]
        },
        {
          pregunta: "Las 'causas' de un accidente de trabajo pueden clasificarse en actos inseguros y __________ inseguras.",
          tipus: "completar",
          correcta: "condiciones",
          opcionsDesplegable: ["errores", "fallos", "condiciones", "sucesos"]
        },
        {
          pregunta: "¿Cuál de las siguientes es una técnica preventiva de la Medicina del Trabajo?",
          tipus: "test",
          opcions: [
            "Diseño de maquinaria",
            "Medición de ruido",
            "Vigilancia de la salud",
            "Planificación de emergencias"
          ],
          correcta: 2
        },
        {
          pregunta: "Los equipos de protección individual (EPIs) son la primera medida de prevención a aplicar.",
          tipus: "test",
          opcions: ["Verdadero", "Falso"],
          correcta: 1 // Falso, son la última barrera de protección, tras eliminar o reducir el riesgo en origen
        },
        {
          pregunta: "Un riesgo psicosocial puede estar relacionado con:",
          tipus: "test",
          opcions: [
            "Vibraciones",
            "Productos químicos",
            "Estrés",
            "Cortes"
          ],
          correcta: 2
        }
      ],
      3: [
        // Nuevas preguntas del PowerPoint - Nivel 3
        {
          pregunta: "La Ley de Prevención de Risgos Laborales se aplica a:",
          tipus: "test",
          opcions: [
            "Solo trabajadores por cuenta ajena.",
            "Trabajadores por cuenta ajena y autónomos.",
            "Todos los trabajadores, incluyendo funcionarios y personal al servicio de las Administraciones Públicas.",
            "Empresarios únicamente."
          ],
          correcta: 2
        },
        {
          pregunta: "El empresario debe garantizar la protección de los trabajadores frente a los riesgos laborales, mediante la adopción de cuántas medidas sean necesarias. Este principio se basa en el deber de ____________.",
          tipus: "completar",
          correcta: "protección",
          opcionsDesplegable: ["responsabilidad", "cooperación", "protección", "vigilancia"]
        },
        {
          pregunta: "Relaciona el derecho del trabajador con su descripción:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Derecho a la información", correcta: "Conocer los riesgos de su puesto y las medidas preventivas." },
            { esquerra: "Derecho a la formación", correcta: "Recibir formación específica y suficiente." },
            { esquerra: "Derecho de participación y consulta", correcta: "Proponer mejoras en las condiciones de trabajo." },
            { esquerra: "Derecho a la paralización", correcta: "Paralizar la actividad si hay riesgo grave e inminente." }
          ]
        },
        {
          pregunta: "¿Qué medida se debe adoptar siempre antes de recurrir a los equipos de protección individual (EPIs)?",
          tipus: "test",
          opcions: [
            "Formar al trabajador en el uso del EPI.",
            "Evaluar el riesgo.",
            "Adoptar medidas de protección colectiva o eliminar el riesgo en origen.",
            "Vigilar la salud del trabajador."
          ],
          correcta: 2
        },
        {
          pregunta: "Los ____________ de Prevención son los representantes de los trabajadores con funciones específicas en materia de prevención de riesgos laborales.",
          tipus: "completar",
          correcta: "Delegados",
          opcionsDesplegable: ["Gestores", "Comités", "Delegados", "Coordinadores"]
        },
        {
          pregunta: "El Comité de Seguridad y Salud es obligatorio en empresas con más de _________ trabajadores.",
          tipus: "completar",
          correcta: "50",
          opcionsDesplegable: ["10", "25", "50", "100"]
        },
        {
          pregunta: "Relaciona el documento preventivo con su objetivo:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Evaluación de Riesgos", correcta: "Identificar los peligros y valorar los riesgos para la seguridad y salud." },
            { esquerra: "Planificación de la Actividad Preventiva", correcta: "Definir cómo se van a controlar y reducir los riesgos identificados." },
            { esquerra: "Plan de Prevención", correcta: "Establecer la estructura de la gestión preventiva en la empresa." }
          ]
        },
        {
          pregunta: "La vigilancia de la salud debe ser ___________, salvo excepciones como las recogidas en la normativa.",
          tipus: "completar",
          correcta: "voluntaria",
          opcionsDesplegable: ["obligatoria", "periódica", "voluntaria", "gratuita"]
        },
        {
          pregunta: "¿Qué organismo es el encargado de la vigilancia y el control del cumplimiento de la normativa de prevención de riesgos laborales?",
          tipus: "test",
          opcions: [
            "El Servicio de Prevención de la empresa.",
            "El Comité de Seguridad y Salud.",
            "La Inspección de Trabajo y Seguridad Social.",
            "Los Delegados de Prevención."
          ],
          correcta: 2
        },
        {
          pregunta: "Los accidentes de trabajo deben ser comunicados a la autoridad laboral en un plazo de _________ días hábiles.",
          tipus: "completar",
          correcta: "cinco",
          opcionsDesplegable: ["tres", "cinco", "diez", "quince"]
        },
        {
          pregunta: "Relaciona el tipo de emergencia con la acción principal:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Conato de emergencia", correcta: "Se controla con los medios disponibles en el lugar de trabajo." },
            { esquerra: "Emergencia parcial", correcta: "Se extienden a varios sectores y requieren desalojo parcial." },
            { esquerra: "Emergencia general", correcta: "Requiere la evacuación total del centro de trabajo." }
          ]
        },
        {
          pregunta: "¿Quién es el responsable de elaborar y mantener actualizado el Plan de Autoprotección de la empresa?",
          tipus: "test",
          opcions: [
            "Los trabajadores designados.",
            "El Servicio de Prevención.",
            "El propio empresario.",
            "Un técnico externo cualificado."
          ],
          correcta: 2 // El empresario es el responsable último de la prevención y, por ende, de los planes de autoprotección.
        },
        {
          pregunta: "La gestión de la prevención en la empresa debe ser un proceso ____________ y ____________.",
          tipus: "completar",
          correcta: "continuo y dinámico",
          opcionsDesplegable: ["estático y rígido", "obligatorio y anual", "continuo y dinámico", "teórico y práctico"]
        },
        {
          pregunta: "¿Qué tipo de EPI se utilizaría para proteger las manos de cortes?",
          tipus: "test",
          opcions: [
            "Casco de seguridad",
            "Gafas de protección",
            "Guantes anticorte",
            "Calzado de seguridad"
          ],
          correcta: 2
        },
        {
          pregunta: "Relaciona el tipo de EPI con la zona del cuerpo que protege:",
          tipus: "relacionar",
          parelles: [
            { esquerra: "Casco", correcta: "Cabeza" },
            { esquerra: "Mascarilla", correcta: "Vías respiratorias" },
            { esquerra: "Botas de seguridad", correcta: "Pies" },
            { esquerra: "Gafas de seguridad", correcta: "Ojos" }
          ]
        },
        {
          pregunta: "La Ley de Prevención de Riesgos Laborales tiene como objetivo promover la mejora de las condiciones de trabajo para elevar el nivel de ____________ y ____________ de los trabajadores.",
          tipus: "completar",
          correcta: "seguridad y salud",
          opcionsDesplegable: ["productividad y eficiencia", "seguridad y salud", "bienestar y confort", "salario y beneficios"]
        },
        {
          pregunta: "¿Qué principio de la acción preventiva implica adaptar el trabajo a la persona?",
          tipus: "test",
          opcions: [
            "Planificación de la prevención",
            "Evitar los riesgos",
            "Evaluar los riesgos inevitables",
            "Adaptar el trabajo a la persona, en particular en lo que respecta a la concepción de los puestos de trabajo."
          ],
          correcta: 3
        },
        {
          pregunta: "Las medidas de emergencia deben incluir los ___________, la ___________ y los ___________ en caso de siniestro.",
          tipus: "completar",
          correcta: "primeros auxilios, lucha contra incendios, evacuación de los trabajadores",
          opcionsDesplegable: [
            "primeros auxilios, formación y simulacros",
            "primeros auxilios, equipos de rescate y zonas seguras",
            "primeros auxilios, lucha contra incendios, evacuación de los trabajadores",
            "señalización, protocolos y alarmas"
          ]
        },
        {
          pregunta: "El principio de 'integrar la prevención en el conjunto de actividades de la empresa' significa que debe estar presente en todas las decisiones y en todos los __________.",
          tipus: "completar",
          correcta: "niveles",
          opcionsDesplegable: ["departamentos", "empleados", "niveles", "proyectos"]
        },
        {
          pregunta: "¿Qué importancia tiene la 'cooperación' entre empresario y trabajadores en la prevención de riesgos?",
          tipus: "test",
          opcions: [
            "Es opcional y no afecta a la eficacia preventiva.",
            "Es fundamental para el éxito de la acción preventiva.",
            "Solo es necesaria en empresas con muchos trabajadores.",
            "Es responsabilidad exclusiva del empresario."
          ],
          correcta: 1
        }
      ]
    };

    let nivellActual = 0;
    let preguntesOriginalsNivell = []; // Contiene todas las preguntas del nivel (base para el total)
    let preguntesPendents = []; // Preguntas que aún deben ser acertadas para "completar" el nivel
    let preguntaIndexActual = 0; // Índice de la pregunta actual dentro de preguntesPendents
    let encerts = 0; // Conteo de aciertos totales (puede incluir aciertos de preguntas repetidas)
    let totalPreguntasRespondidasEnNivel = 0; // Contador para el total de preguntas respondidas en el nivel actual

    const quizContainer = document.getElementById('quiz-container');
    const questionArea = document.getElementById('question-area');
    const feedbackDiv = document.getElementById('feedback');
    const scoreDisplay = document.getElementById('score'); // Correcto: "Encerts totals"
    const nextBtn = document.getElementById('next-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progress-container');
    // const progressText = document.getElementById('progress-text'); // ESTA LÍNEA TAMBIÉN HA SIDO COMENTADA/ELIMINADA

    // Modals
    const nivellCompletatModal = document.getElementById('nivellCompletatModal');
    const nivellCompletatText = document.getElementById('nivellCompletatText');
    const botoPujarNivell = document.getElementById('botoPujarNivell');
    const repasModal = document.getElementById('repasModal');
    const preguntesFalladesContainer = document.getElementById('preguntesFalladesContainer');
    const finalTestModal = document.getElementById('finalTestModal');

    // Listener para el botón "Següent"
    nextBtn.addEventListener('click', () => {
        feedbackDiv.textContent = ''; // Limpiar feedback
        nextBtn.classList.add('hidden'); // Ocultar botón
        mostrarPregunta();
    });


    function iniciaNivell(nivell) {
      nivellActual = nivell;
      preguntesOriginalsNivell = [...totsElsNivellsPreguntes[nivellActual]]; // Copia las preguntas originales del nivel
      preguntesPendents = shuffleArray([...preguntesOriginalsNivell]); // Todas las preguntas al inicio son pendientes
      preguntaIndexActual = 0; // Se reinicia el índice para el array mezclado
      encerts = 0; // Reiniciar aciertos para el nuevo nivel
      totalPreguntasRespondidasEnNivel = 0; // Reiniciar el contador de preguntas respondidas para el nivel

      quizContainer.classList.remove('hidden');
      progressContainer.classList.remove('hidden');
      updateScoreText(); // Inicializa el score
      updateProgressBar(); // Inicializa la barra de progreso
      mostrarPregunta();
      amagaModal(); // Asegurarse de que los modales estén ocultos al iniciar nivel
      amagaRepasModal();
      amagaFinalTestModal();
      actualitzaEstatBotonsNivell();
    }

    function actualitzaEstatBotonsNivell() {
      document.querySelectorAll('.level-button').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
      });
    }

    function mostrarPregunta() {
      if (preguntesPendents.length === 0) {
        mostraNivellCompletatModal();
        return;
      }

      if (preguntaIndexActual >= preguntesPendents.length) {
          preguntesPendents = shuffleArray(preguntesPendents); // Mezcla las pendientes
          preguntaIndexActual = 0; // Reinicia el índice para la nueva tanda
      }

      const pregunta = preguntesPendents[preguntaIndexActual];
      questionArea.innerHTML = ''; // Limpiar contenido anterior

      const preguntaText = document.createElement('p');
      preguntaText.classList.add('mb-4', 'font-medium', 'text-xl');
      preguntaText.innerHTML = pregunta.pregunta;
      questionArea.appendChild(preguntaText);

      switch (pregunta.tipus) {
        case 'test':
          mostrarPreguntaTest(pregunta);
          break;
        case 'completar':
          mostrarPreguntaCompletar(pregunta);
          break;
        case 'relacionar':
          mostrarPreguntaRelacionar(pregunta);
          break;
      }
      feedbackDiv.textContent = '';
      nextBtn.classList.add('hidden'); // Ocultar el botón "Siguiente" hasta que se responda
      desbloquejaInteraccio(); // Asegurarse de que las opciones estén habilitadas
    }

    function validarRespuesta(esCorrecta) {
      bloquejaInteraccio();
      nextBtn.classList.remove('hidden');

      totalPreguntasRespondidasEnNivel++; // Incrementa el contador de preguntas respondidas en ESTE NIVEL (para el score)

      const preguntaActual = preguntesPendents[preguntaIndexActual]; // La pregunta que se acaba de responder

      if (esCorrecta) {
        feedbackDiv.innerHTML = "<p class='text-green-600 font-bold'>😊 Molt bé, has encertat la pregunta!</p>";
        encerts++;
        
        // Si la pregunta actual está en preguntesPendents, la removemos.
        preguntesPendents.splice(preguntaIndexActual, 1);
        // NO incrementamos preguntaIndexActual aquí, porque al eliminar un elemento,
        // el siguiente elemento se "mueve" a la posición actual.
      } else {
        feedbackDiv.innerHTML = "<p class='text-red-600 font-bold'>😢 Ohhh! No és correcte!</p>";
        registraFallada(preguntaActual); // Registra la pregunta fallada para el repaso final
        
        // Si se falla, la pregunta se mantiene en `preguntesPendents` y, para que se repita más tarde,
        // la movemos al final de la lista.
        const preguntaMovida = preguntesPendents.splice(preguntaIndexActual, 1)[0];
        preguntesPendents.push(preguntaMovida);
      }
      
      updateScoreText(); // Actualizar el marcador de aciertos (Encerts totals)
      updateProgressBar(); // Actualizar la barra de progreso
    }


    function mostrarPreguntaTest(pregunta) {
      const opcionesDiv = document.createElement('div');
      opcionesDiv.id = 'opcions';
      opcionesDiv.classList.add('grid', 'grid-cols-1', 'gap-3');

      pregunta.opcions.forEach((opcion, index) => {
        const button = document.createElement('button');
        button.classList.add('opc', 'w-full', 'text-left', 'px-4', 'py-3', 'mb-2', 'border', 'rounded-lg', 'bg-gray-50', 'hover:bg-gray-100', 'transition-colors', 'duration-150');
        button.innerHTML = opcion;
        button.onclick = () => {
          const esCorrecta = (index === pregunta.correcta);
          if (esCorrecta) {
            button.classList.add('bg-green-300', 'text-green-800');
          } else {
            button.classList.add('bg-red-300', 'text-red-800');
            opcionesDiv.children[pregunta.correcta].classList.add('bg-green-300', 'text-green-800'); // Mostrar la correcta
          }
          validarRespuesta(esCorrecta);
        };
        opcionesDiv.appendChild(button);
      });
      questionArea.appendChild(opcionesDiv);
    }

    function mostrarPreguntaCompletar(pregunta) {
      const selectDiv = document.createElement('div');
      selectDiv.classList.add('mb-4');
      selectDiv.innerHTML = `
        <label for="respuesta-completar" class="block text-lg font-medium mb-2">Selecciona la opción correcta para completar la frase:</label>
        <select id="respuesta-completar" class="w-full px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500">
          <option value="" disabled selected>Selecciona una opción</option>
          ${shuffleArray([...pregunta.opcionsDesplegable]).map(op => `<option value="${op}">${op}</option>`).join('')}
        </select>
        <button id="validar-completar" class="mt-4 bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">Comprova</button>
      `;
      questionArea.appendChild(selectDiv);

      document.getElementById('validar-completar').onclick = () => {
        const select = document.getElementById('respuesta-completar');
        const userAnswer = select.value.trim();
        const esCorrecta = (userAnswer === pregunta.correcta);

        select.disabled = true; // Deshabilitar select
        document.getElementById('validar-completar').disabled = true; // Deshabilitar botón de validar

        if (esCorrecta) {
          select.classList.add('bg-green-100', 'border-green-500');
        } else {
          select.classList.add('bg-red-100', 'border-red-500');
          feedbackDiv.innerHTML = `<p class='text-red-600 font-bold'>😢 No és correcte. La resposta correcta és: <strong>${pregunta.correcta}</strong></p>`;
        }
        validarRespuesta(esCorrecta);
      };
    }


    function mostrarPreguntaRelacionar(pregunta) {
      const relacionarDiv = document.createElement('div');
      relacionarDiv.classList.add('grid', 'grid-cols-2', 'gap-4', 'mb-4');

      let allRightOptions = pregunta.parelles.map(p => p.correcta);

      pregunta.parelles.forEach((pareja, index) => {
        const leftSide = document.createElement('div');
        leftSide.classList.add('text-lg', 'font-medium', 'py-2');
        leftSide.textContent = pareja.esquerra;
        relacionarDiv.appendChild(leftSide);

        const selectDiv = document.createElement('div');
        const select = document.createElement('select');
        select.id = `relacionar-${index}`;
        select.classList.add('w-full', 'px-3', 'py-2', 'border', 'rounded-lg', 'bg-white', 'focus:ring-2', 'focus:ring-blue-500');

        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "Selecciona una opción";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        select.appendChild(defaultOption);

        shuffleArray([...allRightOptions]).forEach(opcion => { // Barajar para cada select
          const option = document.createElement('option');
          option.value = opcion;
          option.textContent = opcion;
          select.appendChild(option);
        });
        selectDiv.appendChild(select);
        relacionarDiv.appendChild(selectDiv);
      });

      questionArea.appendChild(relacionarDiv);

      const validarBtn = document.createElement('button');
      validarBtn.id = 'validar-relacionar';
      validarBtn.classList.add('mt-4', 'bg-blue-600', 'text-white', 'px-5', 'py-2', 'rounded-lg', 'hover:bg-blue-700', 'transition-colors', 'duration-200');
      validarBtn.textContent = 'Comprova';
      validarBtn.onclick = () => {
        const selects = questionArea.querySelectorAll('select');
        let allCorrect = true;

        selects.forEach((select, index) => {
          select.disabled = true; // Deshabilitar select
          const correctAnswer = pregunta.parelles[index].correcta;
          if (select.value === correctAnswer) {
            select.classList.add('bg-green-100', 'border-green-500');
          } else {
            allCorrect = false;
            select.classList.add('bg-red-100', 'border-red-500');
            // Opcional: mostrar la respuesta correcta
            const correctOption = document.createElement('span');
            correctOption.classList.add('text-sm', 'text-green-700', 'ml-2', 'font-bold');
            correctOption.textContent = ` (Correcte: ${correctAnswer})`;
            select.parentNode.appendChild(correctOption);
          }
        });
        validarRespuesta(allCorrect);
        validarBtn.disabled = true; // Deshabilitar botón de validar
      };
      questionArea.appendChild(validarBtn);
    }

    function bloquejaInteraccio() {
      document.querySelectorAll('#question-area button.opc').forEach(btn => btn.disabled = true);
      const selectCompletar = document.getElementById('respuesta-completar');
      if (selectCompletar) selectCompletar.disabled = true;
      const btnCompletar = document.getElementById('validar-completar');
      if (btnCompletar) btnCompletar.disabled = true;
      document.querySelectorAll('#question-area select').forEach(select => select.disabled = true);
      const btnRelacionar = document.getElementById('validar-relacionar');
      if (btnRelacionar) btnRelacionar.disabled = true;
    }

    function desbloquejaInteraccio() {
      // No necesitamos desbloquear la interacción aquí, ya que cada pregunta se renderiza desde cero
      // y el botón "Siguiente" o los botones de validación manejan el paso.
      // Las opciones se habilitan al ser creadas en mostrarPregunta.
    }

    function updateProgressBar() {
      const totalPreguntasNivel = preguntesOriginalsNivell.length;
      const preguntasCompletadas = totalPreguntasNivel - preguntesPendents.length;
      let percentatge = (preguntasCompletadas / totalPreguntasNivel) * 100;
      percentatge = isNaN(percentatge) ? 0 : percentatge; // Evitar NaN si totalPreguntasNivel es 0
      progressBar.style.width = percentatge + '%';
      
      // ELIMINADA LA ACTUALIZACIÓN DEL TEXTO DE PROGRESO
      // progressText.textContent = `Preguntes completades: ${preguntasCompletadas} / ${totalPreguntasNivel}`;
    }

    function updateScoreText() {
      // La clave está aquí: encerts es el numerador, totalPreguntasRespondidasEnNivel es el denominador
      scoreDisplay.textContent = `Encerts totals: ${encerts} / ${totalPreguntasRespondidasEnNivel}`;
    }

    // Funciones para los Modales
    function mostraNivellCompletatModal() {
      nivellCompletatText.textContent = `Has completat el Nivell ${nivellActual}!`;
      if (nivellActual < Object.keys(totsElsNivellsPreguntes).length) {
        botoPujarNivell.classList.remove('hidden');
      } else {
        botoPujarNivell.classList.add('hidden'); // Últim nivell, no hi ha més per pujar
      }
      nivellCompletatModal.style.display = 'flex'; // Mostrar el modal
    }

    function amagaModal() {
      nivellCompletatModal.style.display = 'none'; // Amagar el modal
    }

    function repetirNivell() {
      amagaModal();
      iniciaNivell(nivellActual); // Reinicia el nivell actual
    }

    function pujarNivell() {
      if (nivellActual < Object.keys(totsElsNivellsPreguntes).length) {
        amagaModal();
        iniciaNivell(nivellActual + 1); // Passa al següent nivell
      } else {
        // Si es el último nivel, muestra el modal de final de test
        mostraFinalTestModal();
      }
    }

    let preguntesFalladesGlobal = []; // Para acumular todas las preguntas falladas a lo largo de los niveles

    function registraFallada(preguntaFallada) {
        // Verifica si la pregunta ya existe en preguntesFalladesGlobal (para evitar duplicados)
        // Se considera duplicado si la pregunta (el texto) es la misma.
        const yaExiste = preguntesFalladesGlobal.some(q => q.pregunta === preguntaFallada.pregunta);
        if (!yaExiste) {
            preguntesFalladesGlobal.push(preguntaFallada);
        }
    }

    function mostraRepasFallades() {
        amagaModal(); // Asegurarse de que el modal de nivel completado esté oculto
        amagaFinalTestModal(); // Ocultar el modal de final de test si estaba visible

        if (preguntesFalladesGlobal.length === 0) {
            preguntesFalladesContainer.innerHTML = '<p class="text-gray-500">¡No has tingut cap fallada! Molt bé!</p>';
        } else {
            preguntesFalladesContainer.innerHTML = ''; // Limpiar el contenedor
            preguntesFalladesGlobal.forEach((pregunta, index) => {
                const divPregunta = document.createElement('div');
                divPregunta.classList.add('mb-4', 'p-3', 'border', 'rounded-lg', 'bg-red-50');
                
                let respuestaCorrectaTexto = '';
                switch (pregunta.tipus) {
                    case 'test':
                        respuestaCorrectaTexto = pregunta.opcions[pregunta.correcta];
                        break;
                    case 'completar':
                        respuestaCorrectaTexto = pregunta.correcta;
                        break;
                    case 'relacionar':
                        respuestaCorrectaTexto = '<ul>' + pregunta.parelles.map(p => `<li>${p.esquerra}: <strong>${p.correcta}</strong></li>`).join('') + '</ul>';
                        break;
                }
                
                divPregunta.innerHTML = `
                    <p class="font-semibold text-gray-800 mb-1">Pregunta ${index + 1}: ${pregunta.pregunta}</p>
                    <p class="text-red-700">La teva resposta va ser incorrecta.</p>
                    <p class="text-green-700">La resposta correcta era: ${respuestaCorrectaTexto}</p>
                `;
                preguntesFalladesContainer.appendChild(divPregunta);
            });
        }
        repasModal.style.display = 'flex';
    }

    function amagaRepasModal() {
        repasModal.style.display = 'none';
    }

    function mostraFinalTestModal() {
        finalTestModal.style.display = 'flex';
    }

    function amagaFinalTestModal() {
        finalTestModal.style.display = 'none';
    }

    // Función de utilidad para barajar arrays
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
  </script>
  <script>
  // Si aquest fitxer s'està carregant dins un iframe...
  if (window !== window.parent) {
    window.addEventListener('load', () => {
      const height = document.documentElement.scrollHeight;
      // Enviem un missatge al parent (landing page)
      parent.postMessage({ type: 'resize-iframe', height }, '*');
    });
  }
</script>

</body>
</html>
